# 天氣變化通知擴充功能｜實作紀錄

本紀錄說明本專案的技術選型、架構與開發流程，並整理打包與載入成 Chrome 擴充功能的步驟，以及常見問題與改善方向。

- 技術棧：Vite + Vue 3 (Composition API)，Manifest V3 擴充功能
- 入口頁面：popup.html（已在開發與打包流程中指向該檔）
- API：OpenWeatherMap（即時天氣、One Call 3.0、3 小時預報），IP 定位使用 ipapi.co
- 目標：在擴充功能 Popup 顯示天氣，並在背景週期性偵測天氣變化與推播通知

---

## 專案結構重點

- popup.html：擴充功能的 Popup 入口頁面（Vite 的 HTML entry）
- public/
  - manifest.json：MV3 設定，action.default_popup 指向 popup.html；宣告 permissions、host_permissions 與 background service worker
  - background.js：背景週期任務（alarms）與通知（chrome.notifications）
  - favicon.ico：通知與擴充圖示
- src/
  - main.js：建立 Vue 應用並掛載 #app
  - App.vue：載入 WeatherForecast.vue
  - components/WeatherForecast.vue：主要 UI 與前端邏輯（取得座標、拉天氣、去重推播、週期刷新）
- vite.config.js：
  - plugins：@vitejs/plugin-vue、vite-plugin-vue-devtools
  - resolve.alias：@ 指向 src
  - build.rollupOptions.input：指定 ./popup.html 為打包入口
- package.json：
  - scripts：
    - dev：vite --open /popup.html（開發時直接開啟 Popup 頁面）
    - build：vite build（產生 dist/，並自動複製 public/ 內容與處理 HTML entry）

---

## 權限與 Manifest 說明

- manifest_version: 3
- action.default_popup: popup.html
- permissions: [notifications, storage, alarms, geolocation]
- host_permissions: [https://api.openweathermap.org/*, https://ipapi.co/*]
- background.service_worker: background.js（type: module）

這些權限對應：
- notifications：背景腳本用 chrome.notifications 在系統層發通知
- storage：儲存使用者設定與最後已通知的 key（去重）
- alarms：每 10 分鐘喚醒一次背景腳本執行偵測
- geolocation：在 Popup 內用瀏覽器定位（HTTPS/擴充環境）

---

## 功能設計

前端（Popup / WeatherForecast.vue）：
- 定位方式三選一：
  - geo：瀏覽器定位（需安全環境；開發伺服器 http 會被阻擋，但在擴充 Popup 可用）
  - manual：手動輸入城市或郵遞區號，先呼叫地理編碼再查天氣
  - ip：以 IP 推估座標
- 天氣資料：
  - 目前天氣（/data/2.5/weather）
  - 下一步預報：優先 One Call 3.0 的下一小時；若失敗改 3 小時預報（/data/2.5/forecast）
  - 顯示溫度、天氣描述、降雨機率
- 通知策略：
  - 只有在天氣主類別不同或溫差 ≥ 2°C 時才發通知
  - 去重時間窗：45 分鐘；使用 localStorage 與 chrome.storage.local 同步 key
- 設定與狀態：
  - chrome.storage.local 儲存 locationMethod、locationInput 與 lastKnown（供背景腳本使用）
  - 每 10 分鐘自動刷新一次
  - 對 geolocation 權限被拒、HTTP 非安全環境、API 失敗等情況顯示友善錯誤

背景（public/background.js）：
- onInstalled/onStartup 時註冊 alarms（每 10 分鐘），觸發 tick()
- 從 storage 讀取設定與 lastKnown，決定座標（manual → geocode、ip → ipapi、geo → 優先 lastKnown，再回退 IP）
- 拉取目前與下一步天氣資料，若符合變化條件則以 chrome.notifications 建立通知
- 與前端共用去重邏輯（在 storage 中存 lastNotify）

---

## 開發環境與啟動

需求：Node.js 20.19+ 或 22.12+

步驟：
1) 安裝依賴
```sh
npm install
```
2) 啟動開發伺服器（自動開啟 /popup.html）
```sh
npm run dev
```
注意：開發伺服器預設為 http，瀏覽器定位（geo）在非安全環境會被阻擋。可改用：
- 在開發時選擇 manual 或 ip 模式測試資料流
- 或先 build 並以擴充功能載入 dist 進行 geolocation/通知測試（建議）

---

## 打包與以擴充功能載入

1) 產出 dist
```sh
npm run build
```
- Vite 會：
  - 以 popup.html 為入口打包
  - 複製 public/ 到 dist/（含 manifest.json、background.js、favicon.ico）

2) Chrome 載入：
- 打開 chrome://extensions
- 右上角啟用「開發人員模式」
- 點「載入未封裝項目」，選擇專案的 dist/ 目錄
- 確認擴充顯示，點擊圖示的 Popup 進行互動

3) 測試重點：
- 三種定位模式（geo 在擴充環境應可使用）
- 通知權限與效果（系統層通知）
- 背景週期通知：可在「擴充功能」→「背景頁面」檢視 service worker log，或暫時縮短 alarms 週期驗證（開發期）

---

## API 與金鑰管理

- 目前 API_KEY 寫在 WeatherForecast.vue 與 public/background.js 內，屬於前端公開範疇，無法真正隱藏
- 建議：若要保護金鑰，改以後端代理簽名與流量控管；或使用限制金鑰（來源網域、配額）
- OpenWeatherMap 參數：units=metric、lang=zh_tw；地理編碼先取得 lat/lon 再查即時/預報

---

## 錯誤處理與邊界情況

- 非安全環境（HTTP）阻擋 geolocation → Popup 內提示並建議改在擴充環境測試
- geolocation 權限被拒 → 顯示引導，並提供改用 IP 模式
- API 回應非 200 或資料缺失 → 顯示錯誤訊息並清空顯示值
- 3.0 One Call 取值失敗 → 回退到 2.5 版 3 小時預報
- 通知去重（45 分鐘）避免洗版
- 背景計算取得座標優先序：manual → ip → lastKnown → ip 回退

---

## 重要實作細節摘記

- 入口頁面已從傳統 index.html 轉為 popup.html，並在：
  - package.json 的 dev 指令使用 --open /popup.html
  - vite.config.js 的 build.rollupOptions.input 指向 ./popup.html
  - manifest.json 的 action.default_popup 設為 popup.html
- WeatherForecast.vue 每 10 分鐘自動刷新一次，與背景 alarms 同步 10 分鐘，兩者互不干擾
- 去重 key 格式：`${currDesc}|${Math.round(currTemp)}|${nextDesc}|${Math.round(nextTemp)}`

---

## 後續可改善項目

- 開發 HTTPS（或以自簽在本機）以便在 dev server 測試 geolocation
- UI 美化與深色模式
- 新增 i18n / 多語
- 更完整的錯誤分類與重試策略
- 可設定通知靈敏度（溫差門檻、時間窗）與自訂更新週期
- 後端代理以保護金鑰，並加入快取降低 API 次數

---

## 快速檢查清單（維運用）

- [ ] popup.html 可正常載入 Vue app
- [ ] manual/ip/geo 三模式可取到資料（geo 請在擴充環境測試）
- [ ] 背景 alarms 每 10 分鐘執行一次，不拋錯
- [ ] 通知可顯示，且 45 分鐘去重生效
- [ ] build 後 dist/ 內含 manifest.json、background.js、popup.html、資產檔

